"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[58432],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>f});var r=t(67294);function l(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){l(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,r,l=function(e,n){if(null==e)return{};var t,r,l={},o=Object.keys(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||(l[t]=e[t]);return l}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(l[t]=e[t])}return l}var a=r.createContext({}),c=function(e){var n=r.useContext(a),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},p=function(e){var n=c(e.components);return r.createElement(a.Provider,{value:n},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},m=r.forwardRef((function(e,n){var t=e.components,l=e.mdxType,o=e.originalType,a=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),u=c(t),m=l,f=u["".concat(a,".").concat(m)]||u[m]||d[m]||o;return t?r.createElement(f,s(s({ref:n},p),{},{components:t})):r.createElement(f,s({ref:n},p))}));function f(e,n){var t=arguments,l=n&&n.mdxType;if("string"==typeof e||l){var o=t.length,s=new Array(o);s[0]=m;var i={};for(var a in n)hasOwnProperty.call(n,a)&&(i[a]=n[a]);i.originalType=e,i[u]="string"==typeof e?e:l,s[1]=i;for(var c=2;c<o;c++)s[c]=t[c];return r.createElement.apply(null,s)}return r.createElement.apply(null,t)}m.displayName="MDXCreateElement"},18128:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>s,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>c});var r=t(87462),l=(t(67294),t(3905));const o={},s="Nginx, Let's Encrypt",i={unversionedId:"Nginx/Nginx_Let-s_Encrypt",id:"Nginx/Nginx_Let-s_Encrypt",title:"Nginx, Let's Encrypt",description:"https://www.grafikart.fr/formations/serveur-linux/nginx-ssl-letsencrypt",source:"@site/docs/Nginx/Nginx_Let-s_Encrypt.md",sourceDirName:"Nginx",slug:"/Nginx/Nginx_Let-s_Encrypt",permalink:"/notebook/docs/Nginx/Nginx_Let-s_Encrypt",draft:!1,editUrl:"https://github.com/scheffershen/notebook/tree/main/docs/Nginx/Nginx_Let-s_Encrypt.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Nginx-fundamentals",permalink:"/notebook/docs/Nginx/Nginx-fundamentals 2015"},next:{title:"How to Use the NGINX RTMP Module to Setup a Streaming Server (Native installation)",permalink:"/notebook/docs/Nginx/RTMP/How to Use the NGINX RTMP Module to Setup a Streaming Server"}},a={},c=[{value:"Installation de l&#39;outil",id:"installation-de-loutil",level:2},{value:"Mise en place du certificat",id:"mise-en-place-du-certificat",level:2},{value:"Le renouvellement",id:"le-renouvellement",level:2}],p={toc:c};function u(e){let{components:n,...t}=e;return(0,l.kt)("wrapper",(0,r.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"nginx-lets-encrypt"},"Nginx, Let's Encrypt"),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"https://www.grafikart.fr/formations/serveur-linux/nginx-ssl-letsencrypt"},"https://www.grafikart.fr/formations/serveur-linux/nginx-ssl-letsencrypt")),(0,l.kt)("p",null,"08/2016"),(0,l.kt)("h2",{id:"installation-de-loutil"},"Installation de l'outil"),(0,l.kt)("p",null,"cloner le client Let's Encrypt depuis le d\xe9p\xf4t Github officiel. "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"sudo git clone https://github.com/letsencrypt/letsencrypt /opt/letsencrypt --depth=1\n")),(0,l.kt)("p",null,"J'ai rajout\xe9 l'option depth=1 afin d'\xe9viter de r\xe9cup\xe9rer l'enti\xe8ret\xe9 de l'historique git. "),(0,l.kt)("p",null,"Si plus tard on souhaite mettre \xe0 jour le client, il nous suffira de faire un pull :"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"cd /opt/letsencrypt \nsudo git pull\n")),(0,l.kt)("h2",{id:"mise-en-place-du-certificat"},"Mise en place du certificat"),(0,l.kt)("p",null,"Nous allons modifier la configuration de notre virtual host nginx :"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"server { \n    # .well-known doit rest\xe9 accessible\n    location ~ /\\.well-known/acme-challenge {\n        allow all;\n    }\n    # On interdit habituellement l'acc\xe8s au dotfiles\n    location ~ /\\. { deny all; access_log off; log_not_found off; }\n}\n")),(0,l.kt)("p",null,"Une fois nginx configur\xe9 pour renvoyer les fichiers contenus dans ce dossier on peut alors utiliser le module webroot pour g\xe9n\xe9rer le certificat :"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"sudo /opt/letsencrypt/letsencrypt-auto certonly --rsa-key-size 4096 --webroot --webroot-path /var/www/mondomaine.fr -d mondomaine.fr\n")),(0,l.kt)("p",null,"Les certificats g\xe9n\xe9r\xe9s, ainsi que les cl\xe9s priv\xe9es sont stock\xe9s dans le dossier ",(0,l.kt)("em",{parentName:"p"},"/etc/letsencrypt/live/")),(0,l.kt)("p",null,"Il va ensuite falloir modifier notre configuration nginx pour prendre en compte ces certificats."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"# Redirection http vers https\nserver {\n    listen 80;\n    listen [::]:80; \n    server_name mondomaine.fr;\n    location ~ /\\.well-known/acme-challenge {\n        allow all;\n    }\n    location / {\n        return 301 https://mondomaine.fr$request_uri; \n    }\n}\n\n# Notre bloc serveur\nserver {\n\n    # spdy pour Nginx < 1.9.5\n    listen 443 ssl spdy;\n    listen [::]:443 ssl spdy;\n    spdy_headers_comp 9;\n\n    # http2 pour Nginx >= 1.9.5\n    #listen 443 ssl http2;\n    #listen [::]:443 ssl http2;\n\n    server_name mondomaine.fr;\n    root /var/www/mondomaine.fr;\n    index index.html index.htm;\n    error_log /var/log/nginx/mondomaine.fr.log notice;\n    access_log off;\n\n    ####    Locations\n    # On cache les fichiers statiques\n    location ~* \\.(html|css|js|png|jpg|jpeg|gif|ico|svg|eot|woff|ttf)$ { expires max; }\n    # On interdit les dotfiles\n    location ~ /\\. { deny all; }\n\n    #### SSL\n    ssl on;\n    ssl_certificate /etc/letsencrypt/live/mondomaine.fr/fullchain.pem;\n    ssl_certificate_key /etc/letsencrypt/live/mondomaine.fr/privkey.pem;\n\n    ssl_stapling on;\n    ssl_stapling_verify on;\n    ssl_trusted_certificate /etc/letsencrypt/live/mondomaine.fr/fullchain.pem;\n    # Google DNS, Open DNS, Dyn DNS\n    resolver 8.8.8.8 8.8.4.4 208.67.222.222 208.67.220.220 216.146.35.35 216.146.36.36 valid=300s;\n    resolver_timeout 3s;    \n\n    ####    Session Tickets\n    # Session Cache doit avoir la m\xeame valeur sur tous les blocs \"server\".\n    ssl_session_cache shared:SSL:100m;\n    ssl_session_timeout 24h;\n    ssl_session_tickets on;\n    # [ATTENTION] il faudra g\xe9n\xe9rer le ticket de session.\n    ssl_session_ticket_key /etc/nginx/ssl/ticket.key;\n\n    # [ATTENTION] Les param\xe8tres Diffie-Helman doivent \xeatre g\xe9n\xe9r\xe9s\n    ssl_dhparam /etc/nginx/ssl/dhparam4.pem;\n\n    ####    ECDH Curve\n    ssl_ecdh_curve secp384r1;\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n    ssl_prefer_server_ciphers on;\n    ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!3DES:!MD5:!PSK';\n\n}    \n")),(0,l.kt)("p",null,"Enfin pour g\xe9n\xe9rer les clefs utilis\xe9es pour les sessions et le Diffie-Helman (soyez patient :))"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"sudo mkdir -p /etc/nginx/ssl &&\nsudo openssl rand 48 -out /etc/nginx/ssl/ticket.key &&\nsudo openssl dhparam -out /etc/nginx/ssl/dhparam4.pem 4096\n")),(0,l.kt)("h2",{id:"le-renouvellement"},"Le renouvellement"),(0,l.kt)("p",null,"Les certificats propos\xe9s par Let's Encrypt sont valables pour une dur\xe9e de 90 jours. Il faudra donc penser \xe0 les renouveler avant la fin de cette p\xe9riode. Pour cela on peut utiliser la commande :"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"/opt/letsencrypt/letsencrypt-auto renew\n")),(0,l.kt)("p",null,"Cette commande renouvelle les certificats sans interaction de la part de l'utilisateur, vous pouvez donc la rajouter dans les t\xe2ches r\xe9currentes de votre syst\xe8me afin de renouveler le certificat au bout d'une certaine p\xe9riode de temps. Cette commande v\xe9rifie la date d'expiration avant de lancer la proc\xe9dure alors on peut la programmer de mani\xe8re hebdomadaire"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"sudo crontab -e\n30 3 * * 0 /opt/letsencrypt/letsencrypt-auto renew >> /var/log/letsencrypt/renewal.log\n")))}u.isMDXComponent=!0}}]);