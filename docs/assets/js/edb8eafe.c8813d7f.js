"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[64453],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>d});var o=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,i=function(e,t){if(null==e)return{};var n,o,i={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var p=o.createContext({}),c=function(e){var t=o.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},u=function(e){var t=c(e.components);return o.createElement(p.Provider,{value:t},e.children)},g="mdxType",s={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},_=o.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,p=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),g=c(n),_=i,d=g["".concat(p,".").concat(_)]||g[_]||s[_]||r;return n?o.createElement(d,a(a({ref:t},u),{},{components:n})):o.createElement(d,a({ref:t},u))}));function d(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,a=new Array(r);a[0]=_;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l[g]="string"==typeof e?e:i,a[1]=l;for(var c=2;c<r;c++)a[c]=n[c];return o.createElement.apply(null,a)}return o.createElement.apply(null,n)}_.displayName="MDXCreateElement"},43733:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>a,default:()=>g,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var o=n(87462),i=(n(67294),n(3905));const r={},a="How to use GeoIP with Nginx on Ubuntu 16.04",l={unversionedId:"Nginx/How to use GeoIP with Nginx on Ubuntu 16_04",id:"Nginx/How to use GeoIP with Nginx on Ubuntu 16_04",title:"How to use GeoIP with Nginx on Ubuntu 16.04",description:"link//www.howtoforge.com/tutorial/how-to-use-geoip-with-nginx-on-ubuntu-16.04/",source:"@site/docs/Nginx/How to use GeoIP with Nginx on Ubuntu 16_04.md",sourceDirName:"Nginx",slug:"/Nginx/How to use GeoIP with Nginx on Ubuntu 16_04",permalink:"/notebook/docs/Nginx/How to use GeoIP with Nginx on Ubuntu 16_04",draft:!1,editUrl:"https://github.com/scheffershen/notebook/tree/main/docs/Nginx/How to use GeoIP with Nginx on Ubuntu 16_04.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"How to Fix 504 Gateway Timeout using Nginx",permalink:"/notebook/docs/Nginx/How to Fix 504 Gateway Timeout using Nginx"},next:{title:"Increase file upload size limit in PHP-Nginx",permalink:"/notebook/docs/Nginx/Increase file upload size limit in PHP-Nginx"}},p={},c=[],u={toc:c};function g(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,o.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"how-to-use-geoip-with-nginx-on-ubuntu-1604"},"How to use GeoIP with Nginx on Ubuntu 16.04"),(0,i.kt)("p",null,"link: ",(0,i.kt)("a",{parentName:"p",href:"https://www.howtoforge.com/tutorial/how-to-use-geoip-with-nginx-on-ubuntu-16.04/"},"https://www.howtoforge.com/tutorial/how-to-use-geoip-with-nginx-on-ubuntu-16.04/"),"\nAuthor:Till Brehm\nPublished:Jul 29, 2016"),(0,i.kt)("p",null,"This tutorial explains how to use the GeoIP module with nginx on Ubuntu 16.04 to find out where your visitors come from. The GeoIP module sets multiple variables like $geoip_country_name, $geoip_country_code, $geoip_city, etc. that you can use in your PHP scripts or directly in your nginx configuration, for example to serve content in different languages based on the user's country."),(0,i.kt)("p",null,"##1 Preliminary Note"),(0,i.kt)("p",null,"I will use this tutorial for the basic Ubuntu-Nginx setup. (",(0,i.kt)("a",{parentName:"p",href:"https://www.howtoforge.com/tutorial/installing-nginx-with-php7-fpm-and-mysql-on-ubuntu-16.04-lts-lemp/"},"https://www.howtoforge.com/tutorial/installing-nginx-with-php7-fpm-and-mysql-on-ubuntu-16.04-lts-lemp/"),")"),(0,i.kt)("p",null,"##2 Find out if Nginx has support for GeoIP"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"nginx -V\n\nroot@server1:~# nginx -V\nnginx version: nginx/1.10.0 (Ubuntu)\nbuilt with OpenSSL 1.0.2g-fips 1 Mar 2016\nTLS SNI support enabled\nconfigure arguments: --with-cc-opt='-g -O2 -fPIE -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2' --with-ld-opt='-Wl,-Bsymbolic-functions -fPIE -pie -Wl,-z,relro -Wl,-z,now' --prefix=/usr/share/nginx --conf-path=/etc/nginx/nginx.conf --http-log-path=/var/log/nginx/access.log --error-log-path=/var/log/nginx/error.log --lock-path=/var/lock/nginx.lock --pid-path=/run/nginx.pid --http-client-body-temp-path=/var/lib/nginx/body --http-fastcgi-temp-path=/var/lib/nginx/fastcgi --http-proxy-temp-path=/var/lib/nginx/proxy --http-scgi-temp-path=/var/lib/nginx/scgi --http-uwsgi-temp-path=/var/lib/nginx/uwsgi --with-debug --with-pcre-jit --with-ipv6 --with-http_ssl_module --with-http_stub_status_module --with-http_realip_module --with-http_auth_request_module --with-http_addition_module --with-http_dav_module --with-http_geoip_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module --with-http_v2_module --with-http_sub_module --with-http_xslt_module --with-stream --with-stream_ssl_module --with-mail --with-mail_ssl_module --with-mkdir /etc/nginx/geoip\n")),(0,i.kt)("p",null,"##3 Download the GeoIP Databases"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"cd /etc/nginx/geoip\n\nwget http://geolite.maxmind.com/download/geoip/database/GeoLiteCountry/GeoIP.dat.gz\n\ngunzip GeoIP.dat.gz\n\nwget http://geolite.maxmind.com/download/geoip/database/GeoLiteCity.dat.gz\n\ngunzip GeoLiteCity.dat.gzthreads\n")),(0,i.kt)("p",null,"##4 Configure Nginx"),(0,i.kt)("p",null,"Now we configure nginx. Open /etc/nginx/nginx.conf..."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"nano /etc/nginx/nginx.conf\n")),(0,i.kt)("p",null,"... and add the geoip_country and geoip_city directives to the http {} container:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-/etc/nginx/nginx.conf"},"    ...\n\n    http {\n\n     ##\n     # Basic Settings\n     ##\n\n     geoip_country /etc/nginx/geoip/GeoIP.dat; # the country IP database\n     geoip_city /etc/nginx/geoip/GeoLiteCity.dat; # the city IP database\n    ...\n\n")),(0,i.kt)("p",null,"The geoip_country directive makes the following variables available:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"$geoip_country_code - two-letter country code, for example, RU, US."),(0,i.kt)("li",{parentName:"ul"},"$geoip_country_code3 - three-letter country code, for example, RUS, USA."),(0,i.kt)("li",{parentName:"ul"},"$geoip_country_name - the (verbose) name of the country, for example, Russian - Federation, United States, etc.")),(0,i.kt)("p",null,"The geoip_city directive provides the following variables:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"$geoip_city_country_code - two-letter country code, for example, RU, US."),(0,i.kt)("li",{parentName:"ul"},"$geoip_city_country_code3 - three-letter country code, for example, RUS, USA."),(0,i.kt)("li",{parentName:"ul"},"$geoip_city_country_name - the name of the country, for example, Russian Federation, United States - if available."),(0,i.kt)("li",{parentName:"ul"},"$geoip_region - the name of region (province, region, state, province, federal land, and the like), for example, Moscow City, DC - if available."),(0,i.kt)("li",{parentName:"ul"},"$geoip_city - the name of the city, for example, Moscow, Washington, Lisbon, etc. - if available."),(0,i.kt)("li",{parentName:"ul"},"$geoip_postal_code - zip code or postal code - if available."),(0,i.kt)("li",{parentName:"ul"},"$geoip_city_continent_code - if available."),(0,i.kt)("li",{parentName:"ul"},"$geoip_latitude - latitude - if available."),(0,i.kt)("li",{parentName:"ul"},"$geoip_longitude - longitude - if available.")),(0,i.kt)("p",null,"In order to make these variables available to your PHP scripts as well, we must set a few fastcgi_param directives. It is best to do this in the file /etc/nginx/fastcgi_params where the other fastcgi_param directives are:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"nano /etc/nginx/fastcgi_params\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-/etc/nginx/fastcgi"},"    ### SET GEOIP Variables ###\n    fastcgi_param GEOIP_COUNTRY_CODE $geoip_country_code;\n    fastcgi_param GEOIP_COUNTRY_CODE3 $geoip_country_code3;\n    fastcgi_param GEOIP_COUNTRY_NAME $geoip_country_name;\n\n    fastcgi_param GEOIP_CITY_COUNTRY_CODE $geoip_city_country_code;\n    fastcgi_param GEOIP_CITY_COUNTRY_CODE3 $geoip_city_country_code3;\n    fastcgi_param GEOIP_CITY_COUNTRY_NAME $geoip_city_country_name;\n    fastcgi_param GEOIP_REGION $geoip_region;\n    fastcgi_param GEOIP_CITY $geoip_city;\n    fastcgi_param GEOIP_POSTAL_CODE $geoip_postal_code;\n    fastcgi_param GEOIP_CITY_CONTINENT_CODE $geoip_city_continent_code;\n    fastcgi_param GEOIP_LATITUDE $geoip_latitude;\n    fastcgi_param GEOIP_LONGITUDE $geoip_longitude;\n")),(0,i.kt)("p",null,"Make sure you have the line "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"location ~ \\.php$ {\n    ...\n    include /etc/nginx/fastcgi_params;\n    ...\n} \n")),(0,i.kt)("p",null,"in your location ~ ",".","php$ {} container in your vhost configuration, "),(0,i.kt)("p",null,"If you use nginx as a reverse proxy and want to pass the GeoIP variables to the backend, you should create/edit the file /etc/nginx/proxy.conf..."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-/etc/nginx/proxy.conf"},"")),(0,i.kt)("p",null,"Now reload nginx..."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"systemctl reload nginx.service\n")),(0,i.kt)("p",null,"Restart PHP-FPM as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"systemctl restart php7.0-fpm.service\n")),(0,i.kt)("p",null,"##5 A short Test"),(0,i.kt)("p",null,"We can access the GeoIP variables as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$geoip_country_code = getenv(GEOIP_COUNTRY_CODE);\n")),(0,i.kt)("p",null,"Or like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$geoip_country_code = $_SERVER['GEOIP_COUNTRY_CODE'];\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"<?php\n\n$geoip_country_code = getenv(GEOIP_COUNTRY_CODE);\n/*\n$geoip_country_code = $_SERVER['GEOIP_COUNTRY_CODE']; // works as well\n*/\n$geoip_country_code3 = getenv(GEOIP_COUNTRY_CODE3);\n$geoip_country_name = getenv(GEOIP_COUNTRY_NAME);\n\n$geoip_city_country_code = getenv(GEOIP_CITY_COUNTRY_CODE);\n$geoip_city_country_code3 = getenv(GEOIP_CITY_COUNTRY_CODE3);\n$geoip_city_country_name = getenv(GEOIP_CITY_COUNTRY_NAME);\n$geoip_region = getenv(GEOIP_REGION);\n$geoip_city = getenv(GEOIP_CITY);\n$geoip_postal_code = getenv(GEOIP_POSTAL_CODE);\n$geoip_city_continent_code = getenv(GEOIP_CITY_CONTINENT_CODE);\n$geoip_latitude = getenv(GEOIP_LATITUDE);\n$geoip_longitude = getenv(GEOIP_LONGITUDE);\n\necho 'country_code: '.$geoip_country_code.'<br>';\necho 'country_code3: '.$geoip_country_code3.'<br>';\necho 'country_name: '.$geoip_country_name.'<br>';\n\necho 'city_country_code: '.$geoip_city_country_code.'<br>';\necho 'city_country_code3: '.$geoip_city_country_code3.'<br>';\necho 'city_country_name: '.$geoip_city_country_name.'<br>';\necho 'region: '.$geoip_region.'<br>';\necho 'city: '.$geoip_city.'<br>';\necho 'postal_code: '.$geoip_postal_code.'<br>';\necho 'city_continent_code: '.$geoip_city_continent_code.'<br>';\necho 'latitude: '.$geoip_latitude.'<br>';\necho 'longitude: '.$geoip_longitude.'<br>';\n\n?>\n\n")))}g.isMDXComponent=!0}}]);