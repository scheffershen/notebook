"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[82],{3905:(e,t,n)=>{n.d(t,{Zo:()=>m,kt:()=>p});var r=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=r.createContext({}),c=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},m=function(e){var t=c(e.components);return r.createElement(s.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},h=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,s=e.parentName,m=i(e,["components","mdxType","originalType","parentName"]),u=c(n),h=o,p=u["".concat(s,".").concat(h)]||u[h]||d[h]||a;return n?r.createElement(p,l(l({ref:t},m),{},{components:n})):r.createElement(p,l({ref:t},m))}));function p(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,l=new Array(a);l[0]=h;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i[u]="string"==typeof e?e:o,l[1]=i;for(var c=2;c<a;c++)l[c]=n[c];return r.createElement.apply(null,l)}return r.createElement.apply(null,n)}h.displayName="MDXCreateElement"},95498:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>u,frontMatter:()=>a,metadata:()=>i,toc:()=>c});var r=n(87462),o=(n(67294),n(3905));const a={},l="How to implement fulltext search (MySql) with Doctrine and Symfony 3",i={unversionedId:"Symfony/Doctrine/How-to-implement-fulltext-search-MySql-with-Doctrine-and-Symfony-3",id:"Symfony/Doctrine/How-to-implement-fulltext-search-MySql-with-Doctrine-and-Symfony-3",title:"How to implement fulltext search (MySql) with Doctrine and Symfony 3",description:"Note: This tutorial will works for Symfony < 2.x versions too.",source:"@site/docs/Symfony/Doctrine/How-to-implement-fulltext-search-MySql-with-Doctrine-and-Symfony-3.md",sourceDirName:"Symfony/Doctrine",slug:"/Symfony/Doctrine/How-to-implement-fulltext-search-MySql-with-Doctrine-and-Symfony-3",permalink:"/notebook/docs/Symfony/Doctrine/How-to-implement-fulltext-search-MySql-with-Doctrine-and-Symfony-3",draft:!1,editUrl:"https://github.com/scheffershen/notebook/tree/main/docs/Symfony/Doctrine/How-to-implement-fulltext-search-MySql-with-Doctrine-and-Symfony-3.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Doctrine ObjectManager vs Doctrine EntityManagerInterface",permalink:"/notebook/docs/Symfony/Doctrine/Doctrine-ObjectManager-vs-EntityManagerInteface"},next:{title:'What is the difference between fetch="EAGER" and fetch="LAZY" in doctrine',permalink:"/notebook/docs/Symfony/Doctrine/What is the difference between fetch=EAGER and fetch=LAZY in doctrine"}},s={},c=[{value:"MatchAgainst Class",id:"matchagainst-class",level:2},{value:"Register the function in config.yml",id:"register-the-function-in-configyml",level:2},{value:"Add the fulltext indexes to your table fields",id:"add-the-fulltext-indexes-to-your-table-fields",level:2},{value:"Creating queries",id:"creating-queries",level:2},{value:"next",id:"next",level:2},{value:"Resources",id:"resources",level:2}],m={toc:c};function u(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,r.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"how-to-implement-fulltext-search-mysql-with-doctrine-and-symfony-3"},"How to implement fulltext search (MySql) with Doctrine and Symfony 3"),(0,o.kt)("p",null,"Note: This tutorial will works for Symfony < 2.x versions too."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT * FROM myTable WHERE match(fieldName) against('I search this text' IN BOOLEAN MODE) LIMIT 10;\n")),(0,o.kt)("p",null,"To use the match and against statements in doctrine 2 with MySQL, we'll need to :"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Create the MatchAgainst function"),(0,o.kt)("li",{parentName:"ul"},"Register the custom function in the symfony configuration (config.yml)"),(0,o.kt)("li",{parentName:"ul"},"Add the FULLTEXT indexes to the fields that you need to the database"),(0,o.kt)("li",{parentName:"ul"},"Execute some queries !")),(0,o.kt)("h2",{id:"matchagainst-class"},"MatchAgainst Class"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},'// myBundle/Extensions/Doctrine/MatchAgainst.php\n \nnamespace myBundle\\Extensions\\Doctrine;\n\nuse Doctrine\\ORM\\Query\\Lexer;\nuse Doctrine\\ORM\\Query\\AST\\Functions\\FunctionNode;\n\n/**\n * "MATCH_AGAINST" "(" {StateFieldPathExpression ","}* InParameter {Literal}? ")"\n */\nclass MatchAgainst extends FunctionNode {\n\n    public $columns = array();\n    public $needle;\n    public $mode;\n\n    public function parse(\\Doctrine\\ORM\\Query\\Parser $parser) {\n        $parser->match(Lexer::T_IDENTIFIER);\n        $parser->match(Lexer::T_OPEN_PARENTHESIS);\n        do {\n            $this->columns[] = $parser->StateFieldPathExpression();\n            $parser->match(Lexer::T_COMMA);\n        } while ($parser->getLexer()->isNextToken(Lexer::T_IDENTIFIER));\n        $this->needle = $parser->InParameter();\n        while ($parser->getLexer()->isNextToken(Lexer::T_STRING)) {\n            $this->mode = $parser->Literal();\n        }\n        $parser->match(Lexer::T_CLOSE_PARENTHESIS);\n    }\n\n    public function getSql(\\Doctrine\\ORM\\Query\\SqlWalker $sqlWalker) {\n        $haystack = null;\n        $first = true;\n        foreach ($this->columns as $column) {\n            $first ? $first = false : $haystack .= \', \';\n            $haystack .= $column->dispatch($sqlWalker);\n        }\n        $query = "MATCH(" . $haystack .\n                ") AGAINST (" . $this->needle->dispatch($sqlWalker);\n        if ($this->mode) {\n            $query .= " " . $this->mode->dispatch($sqlWalker) . " )";\n        } else {\n            $query .= " )";\n        }\n        \n        return $query;\n    }\n}\n')),(0,o.kt)("h2",{id:"register-the-function-in-configyml"},"Register the function in config.yml"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'# Doctrine Configuration\ndoctrine:\n    # Search for the ORM property\n    orm:\n        # Those values should be already in your file and this doesn\'t matter\n        auto_generate_proxy_classes: "%kernel.debug%"\n        naming_strategy: doctrine.orm.naming_strategy.underscore\n        auto_mapping: true\n        # We need this the dql property to register the custom doctrine functions :\n        dql:\n            string_functions:\n                # Match agains should have the path to the MatchAgainst class created in the previous step\n                MATCH_AGAINST: myBundle\\Extensions\\Doctrine\\MatchAgainst\n')),(0,o.kt)("h2",{id:"add-the-fulltext-indexes-to-your-table-fields"},"Add the fulltext indexes to your table fields"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},'"-- fulltext_index is the alias that we\'ll give to the fulltext index"\nALTER TABLE yourTable ADD FULLTEXT fulltext_index(fieldName1, fieldName2, fieldName3)\n')),(0,o.kt)("p",null,"All the fulltext fields needs to be related in the same table to 1 fulltext index, therefore remove the previous fulltext index and add the new one with the old and new fields."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},'"-- If you don\'t know the name of the registered indexes you can use the following line to see them"\nSHOW INDEX FROM tableName\n\n"-- Then drop the index using the name as parameter"\nALTER TABLE table DROP INDEX fulltext_index\n\n"-- And finally add the new index with all the fields"\nALTER TABLE yourTable ADD FULLTEXT fulltext_index(fieldName1,fieldName2,fieldName3,fieldName4, fieldName5)\n')),(0,o.kt)("h2",{id:"creating-queries"},"Creating queries"),(0,o.kt)("p",null,"Natural mode fulltext search example :"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"$result = $yourRepository->createQueryBuilder('p')\n    ->addSelect(\"MATCH_AGAINST (p.fieldName1, p.fieldName2, p.fieldName3, :searchterm 'IN NATURAL MODE') as score\")\n    ->add('where', 'MATCH_AGAINST(p.fieldName1, p.fieldName2, p.fieldName3, :searchterm) > 0.8')\n    ->setParameter('searchterm', \"Test word\")\n    ->orderBy('score', 'desc')\n    ->getQuery()\n    ->getResult();\n\n// with a result structure like :\n// [[\"score\" => '0.3123',\"0\" => \"The array with the information of the row (all fields)\"]]\n")),(0,o.kt)("p",null,'The previous example will match all the rows that contains "Test word" and the records will be sorted decreasingly according to the score (as the rows can contain only test or only word).'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"$result = $yourRepository->createQueryBuilder('p')\n    ->addSelect(\"MATCH_AGAINST (p.fieldName1, p.fieldName2, p.fieldName3, :searchterm 'IN BOOLEAN MODE') as score\")\n    ->add('where', 'MATCH_AGAINST(p.fieldName1, p.fieldName2, p.fieldName3, :searchterm) > 0.8')\n    ->setParameter('searchterm', \"+microsoft ~windows\")\n    ->orderBy('score', 'desc')\n    ->getQuery()\n    ->getResult();\n\n// with a result structure like :\n// [[\"score\" => '1.423',\"0\" => \"Only microsoft in this text with fulltext :) \"]]\n")),(0,o.kt)("p",null,"The previous query will find rows that contain the word \u201cmicrosoft\u201d but not \u201cwindows\u201d."),(0,o.kt)("h2",{id:"next"},"next"),(0,o.kt)("p",null,"In both mode there isn't any change in scoring. Your decision on which to use should be based on whether or not you need the Boolean mode features, read more about ",(0,o.kt)("inlineCode",{parentName:"p"},"boolean mode in fulltext search")," here(",(0,o.kt)("a",{parentName:"p",href:"https://dev.mysql.com/doc/refman/8.0/en/fulltext-boolean.html"},"https://dev.mysql.com/doc/refman/8.0/en/fulltext-boolean.html"),") and more about ",(0,o.kt)("inlineCode",{parentName:"p"},"natural mode")," here(",(0,o.kt)("a",{parentName:"p",href:"https://dev.mysql.com/doc/refman/8.0/en/fulltext-natural-language.html"},"https://dev.mysql.com/doc/refman/8.0/en/fulltext-natural-language.html"),")."),(0,o.kt)("p",null,"You can find more custom functions implementations in ",(0,o.kt)("inlineCode",{parentName:"p"},"DoctrineExtensionsRepository")," by ",(0,o.kt)("inlineCode",{parentName:"p"},"Beberlei")," here(",(0,o.kt)("a",{parentName:"p",href:"https://github.com/beberlei/DoctrineExtensions"},"https://github.com/beberlei/DoctrineExtensions"),") and use the classes from ",(0,o.kt)("inlineCode",{parentName:"p"},"/master/src/Query/Mysql")," directory in order to include only the functions that you need (like Soundex,Ceil,Day etc). Remember to enable them correctly, also ",(0,o.kt)("inlineCode",{parentName:"p"},"checkout this yml file")," (",(0,o.kt)("a",{parentName:"p",href:"https://github.com/beberlei/DoctrineExtensions/blob/master/config/mysql.yml"},"https://github.com/beberlei/DoctrineExtensions/blob/master/config/mysql.yml"),") to see how to register the custom functions."),(0,o.kt)("h2",{id:"resources"},"Resources"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://ourcodeworld.com/articles/read/90/how-to-implement-fulltext-search-mysql-with-doctrine-and-symfony-3"},"https://ourcodeworld.com/articles/read/90/how-to-implement-fulltext-search-mysql-with-doctrine-and-symfony-3"),"\n",(0,o.kt)("a",{parentName:"p",href:"https://stackoverflow.com/questions/17534796/match-against-script-is-not-working-with-symfony2/17536071"},"https://stackoverflow.com/questions/17534796/match-against-script-is-not-working-with-symfony2/17536071")))}u.isMDXComponent=!0}}]);