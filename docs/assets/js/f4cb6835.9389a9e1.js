"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[95410],{3905:(e,n,t)=>{t.d(n,{Zo:()=>l,kt:()=>f});var c=t(67294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);n&&(c=c.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,c)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,c,a=function(e,n){if(null==e)return{};var t,c,a={},i=Object.keys(e);for(c=0;c<i.length;c++)t=i[c],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(c=0;c<i.length;c++)t=i[c],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var s=c.createContext({}),p=function(e){var n=c.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},l=function(e){var n=p(e.components);return c.createElement(s.Provider,{value:n},e.children)},h="mdxType",g={inlineCode:"code",wrapper:function(e){var n=e.children;return c.createElement(c.Fragment,{},n)}},u=c.forwardRef((function(e,n){var t=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,l=o(e,["components","mdxType","originalType","parentName"]),h=p(t),u=a,f=h["".concat(s,".").concat(u)]||h[u]||g[u]||i;return t?c.createElement(f,r(r({ref:n},l),{},{components:t})):c.createElement(f,r({ref:n},l))}));function f(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var i=t.length,r=new Array(i);r[0]=u;var o={};for(var s in n)hasOwnProperty.call(n,s)&&(o[s]=n[s]);o.originalType=e,o[h]="string"==typeof e?e:a,r[1]=o;for(var p=2;p<i;p++)r[p]=t[p];return c.createElement.apply(null,r)}return c.createElement.apply(null,t)}u.displayName="MDXCreateElement"},47543:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>r,default:()=>h,frontMatter:()=>i,metadata:()=>o,toc:()=>p});var c=t(87462),a=(t(67294),t(3905));const i={},r="Nginx FastCGI cache",o={unversionedId:"Nginx/Nginx FastCGI cache",id:"Nginx/Nginx FastCGI cache",title:"Nginx FastCGI cache",description:"http://bl.ocks.org/magnetikonline/10450786",source:"@site/docs/Nginx/Nginx FastCGI cache.md",sourceDirName:"Nginx",slug:"/Nginx/Nginx FastCGI cache",permalink:"/notebook/docs/Nginx/Nginx FastCGI cache",draft:!1,editUrl:"https://github.com/scheffershen/notebook/tree/main/docs/Nginx/Nginx FastCGI cache.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"NGINX as a WebSocket Proxy",permalink:"/notebook/docs/Nginx/NGINX as a WebSocket Proxy"},next:{title:"Nginx Fundamentals High Performance Server",permalink:"/notebook/docs/Nginx/Nginx Fundamentals High Performance Server"}},s={},p=[],l={toc:p};function h(e){let{components:n,...t}=e;return(0,a.kt)("wrapper",(0,c.Z)({},l,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"nginx-fastcgi-cache"},"Nginx FastCGI cache"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"http://bl.ocks.org/magnetikonline/10450786"},"http://bl.ocks.org/magnetikonline/10450786")),(0,a.kt)("p",null,"Will need to create a directory to hold cache files, for the example given here that would be:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ sudo mkdir -p /var/cache/nginxfastcgi\n$ chown www-data: /var/cache/nginxfastcgi\n")),(0,a.kt)("p",null,"example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'http {\n    fastcgi_cache_path /tmp/nginx-cache levels=1:2 keys_zone=microcache:10m inactive=60m;\n    fastcgi_cache_key "$scheme$request_method$host$request_uri";\n}\n')),(0,a.kt)("p",null,'The "fastcgicachepath" directive specifies the location of the cache (/tmp/nginx-cache), its size (10m), memory zone name (microcache), the subdirectory levels, and the inactive` timer.'),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'http {\n    server {\n        location ~ "\\.php$" {\n            fastcgi_cache microcache;\n            fastcgi_cache_valid 200 60m;\n            fastcgi_cache_bypass $no_cache;\n            fastcgi_no_cache $no_cache;\n        }\n')),(0,a.kt)("p",null,'The "fastcgicache" directive references to the memory zone name which we specified in the "fastcgicache_path" directive and stores the cache in this area.'),(0,a.kt)("p",null,"##Setting Cache Exceptions"),(0,a.kt)("p",null,'Some dynamic content such as authentication required pages shouldn\'t be cached. Such content can be excluded from being cached based on server variables like "requesturi," "requestmethod," and "http_cookie."'),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'   http {\n        server {\n            #Cache everything by default\n            set $no_cache 0;\n\n            #Don\'t cache POST requests\n            if ($request_method = POST)\n            {\n                set $no_cache 1;\n            }\n\n            #Don\'t cache if the URL contains a query string\n            if ($query_string != "")\n            {\n                set $no_cache 1;\n            }\n\n            #Don\'t cache the following URLs\n            if ($request_uri ~* "/(administrator/|login.php)")\n            {\n                set $no_cache 1;\n            }\n\n            #Don\'t cache if there is a cookie called PHPSESSID\n            if ($http_cookie = "PHPSESSID")\n            {\n                set $no_cache 1;\n            }\n')),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-nginx.conf"},'user www-data www-data;\nworker_processes 1;\nlock_file /run/lock/nginx.lock;\n\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n    server_tokens off;\n    sendfile on;\n    tcp_nopush on;\n    tcp_nodelay off;\n    keepalive_timeout 5;\n\n    include /etc/nginx/mime.types;\n    default_type application/octet-stream;\n\n    gzip on;\n    gzip_static on;\n    gzip_comp_level 2;\n    gzip_disable "msie6";\n    gzip_proxied any;\n    gzip_types application/javascript application/json application/vnd.ms-fontobject application/x-font-ttf image/svg+xml text/css text/plain text/xml;\n    gzip_vary on;\n \n    fastcgi_cache_path /var/cache/nginxfastcgi levels=1:2 keys_zone=fastcgicache:10m inactive=10m max_size=64m;\n    fastcgi_cache_key $scheme$request_method$host$request_uri;\n    # note: can also use HTTP headers to form the cache key, e.g.\n    #fastcgi_cache_key $scheme$request_method$host$request_uri$http_x_custom_header;\n    fastcgi_cache_lock on;\n    fastcgi_cache_use_stale error timeout invalid_header updating http_500;\n    fastcgi_cache_valid 5m;\n    fastcgi_ignore_headers Cache-Control Expires Set-Cookie;\n\n    index index.php;\n \n \n    server {\n        listen 127.0.0.1:80;\n        server_name sitename.com;\n \n \n        root /var/www/sitename.com;\n        access_log /var/log/nginx/access.log;\n        error_log /var/log/nginx/error.log;\n \n        # example FastCGI cache exception rules\n        set $fastcgi_skipcache 0;\n \n        if ($query_string) {\n            set $fastcgi_skipcache 1;\n        }\n \n        if ($http_x_custom_header) {\n            set $fastcgi_skipcache 0;\n        }\n \n        if ($uri ~ "/path/matches/") {\n            set $fastcgi_skipcache 1;\n        }    \n\n        if ($http_cookie ~ "users_login_cookie") {\n            set $fastcgi_skipcache 1;\n        }\n \n        include /etc/nginx/conf/phpfastcgicache;\n \n        location / {\n            try_files $uri $uri/ /index.php?$query_string;\n        }\n\n        location ~ "\\.php$" {\n            fastcgi_index index.php;\n            if (!-f $realpath_root$fastcgi_script_name) {\n                return 404;\n            }\n \n            # note: adds a HTTP response header "X-Cache" returning HIT/MISS/BYPASS/EXPIRED for cache use status\n            add_header X-Cache $upstream_cache_status;\n            fastcgi_cache fastcgicache;\n            fastcgi_cache_bypass $fastcgi_skipcache;\n            fastcgi_no_cache $fastcgi_skipcache;\n \n            include /etc/nginx/fastcgi_params;\n            fastcgi_pass unix:/run/php5/php-fpm.sock;\n        }\n    }\n}           \n')),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"# Install PHP\n# -qq implies -y --force-yes\nsudo apt-get install -qq php5-cli php5-fpm php5-mysql php5-pgsql php5-sqlite php5-curl php5-gd php5-gmp php5-mcrypt php5-memcached php5-imagick php5-intl php5-xdebug\n")),(0,a.kt)("h1",{id:"set-php-fpm-to-listen-on-tcp-instead-of-socket"},"Set PHP FPM to listen on TCP instead of Socket"),(0,a.kt)("p",null,'sudo sed -i "s/listen =.*/listen = 127.0.0.1:9000/" /etc/php5/fpm/pool.d/www.conf'),(0,a.kt)("h1",{id:"set-php-fpm-allowed-clients-ip-address"},"Set PHP FPM allowed clients IP address"),(0,a.kt)("p",null,'sudo sed -i "s/;listen.allowed_clients/listen.allowed_clients/" /etc/php5/fpm/pool.d/www.conf'))}h.isMDXComponent=!0}}]);