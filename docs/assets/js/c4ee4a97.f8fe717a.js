"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[76364],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>d});var o=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},s=Object.keys(e);for(o=0;o<s.length;o++)n=s[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(o=0;o<s.length;o++)n=s[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=o.createContext({}),l=function(e){var t=o.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},u=function(e){var t=l(e.components);return o.createElement(c.Provider,{value:t},e.children)},p="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},m=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,s=e.originalType,c=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),p=l(n),m=r,d=p["".concat(c,".").concat(m)]||p[m]||h[m]||s;return n?o.createElement(d,a(a({ref:t},u),{},{components:n})):o.createElement(d,a({ref:t},u))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=n.length,a=new Array(s);a[0]=m;var i={};for(var c in t)hasOwnProperty.call(t,c)&&(i[c]=t[c]);i.originalType=e,i[p]="string"==typeof e?e:r,a[1]=i;for(var l=2;l<s;l++)a[l]=n[l];return o.createElement.apply(null,a)}return o.createElement.apply(null,n)}m.displayName="MDXCreateElement"},80030:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>p,frontMatter:()=>s,metadata:()=>i,toc:()=>l});var o=n(87462),r=(n(67294),n(3905));const s={},a="How to Use Voters to Check User Permissions",i={unversionedId:"Symfony/Authorization/How-to-Use-Voters-to-Check-User-Permissions",id:"Symfony/Authorization/How-to-Use-Voters-to-Check-User-Permissions",title:"How to Use Voters to Check User Permissions",description:"How Symfony Uses Voters",source:"@site/docs/Symfony/Authorization/How-to-Use-Voters-to-Check-User-Permissions.md",sourceDirName:"Symfony/Authorization",slug:"/Symfony/Authorization/How-to-Use-Voters-to-Check-User-Permissions",permalink:"/notebook/docs/Symfony/Authorization/How-to-Use-Voters-to-Check-User-Permissions",draft:!1,editUrl:"https://github.com/scheffershen/notebook/tree/main/docs/Symfony/Authorization/How-to-Use-Voters-to-Check-User-Permissions.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"REAMDME",permalink:"/notebook/docs/Symfony/Authentication/SSO/Roche"},next:{title:"installation",permalink:"/notebook/docs/Symfony/Bundles/2fa-bundle/installation"}},c={},l=[{value:"How Symfony Uses Voters",id:"how-symfony-uses-voters",level:2},{value:"The Voter Interface",id:"the-voter-interface",level:2},{value:"Setup: Checking for Access in a Controller",id:"setup-checking-for-access-in-a-controller",level:2},{value:"Creating the custom Voter",id:"creating-the-custom-voter",level:2},{value:"Checking for Roles inside a Voter\xb6",id:"checking-for-roles-inside-a-voter",level:2},{value:"Changing the Access Decision Strategy",id:"changing-the-access-decision-strategy",level:2}],u={toc:l};function p(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,o.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"how-to-use-voters-to-check-user-permissions"},"How to Use Voters to Check User Permissions"),(0,r.kt)("h2",{id:"how-symfony-uses-voters"},"How Symfony Uses Voters"),(0,r.kt)("p",null,"All voters are called each time you use the ",(0,r.kt)("inlineCode",{parentName:"p"},"isGranted()")," method on Symfony's authorization checker or call ",(0,r.kt)("inlineCode",{parentName:"p"},"denyAccessUnlessGranted()")," in a controller"),(0,r.kt)("h2",{id:"the-voter-interface"},"The Voter Interface"),(0,r.kt)("p",null,"A custom voter needs to implement ",(0,r.kt)("inlineCode",{parentName:"p"},"VoterInterface")," or extend ",(0,r.kt)("inlineCode",{parentName:"p"},"Voter"),", which makes creating a voter even easier:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"use Symfony\\Component\\Security\\Core\\Authentication\\Token\\TokenInterface;\nuse Symfony\\Component\\Security\\Core\\Authorization\\Voter\\VoterInterface;\n\nabstract class Voter implements VoterInterface\n{\n    abstract protected function supports($attribute, $subject);\n    abstract protected function voteOnAttribute($attribute, $subject, TokenInterface $token);\n}\n")),(0,r.kt)("h2",{id:"setup-checking-for-access-in-a-controller"},"Setup: Checking for Access in a Controller"),(0,r.kt)("p",null,"Suppose you have a ",(0,r.kt)("inlineCode",{parentName:"p"},"Post")," object and you need to decide whether or not the current user can edit or view the object. In your controller, you'll check access with code like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},'// src/Controller/PostController.php\n// ...\n\nclass PostController extends AbstractController\n{\n    /**\n     * @Route("/posts/{id}", name="post_show")\n     */\n    public function show($id)\n    {\n        // get a Post object - e.g. query for it\n        $post = ...;\n\n        // check for "view" access: calls all voters\n        $this->denyAccessUnlessGranted(\'view\', $post);\n\n        // ...\n    }\n\n    /**\n     * @Route("/posts/{id}/edit", name="post_edit")\n     */\n    public function edit($id)\n    {\n        // get a Post object - e.g. query for it\n        $post = ...;\n\n        // check for "edit" access: calls all voters\n        $this->denyAccessUnlessGranted(\'edit\', $post);\n\n        // ...\n    }\n}\n')),(0,r.kt)("p",null,'The denyAccessUnlessGranted() method (and also the isGranted() method) calls out to the "voter" system. Right now, no voters will vote on whether or not the user can "view" or "edit" a Post. But you can create your own voter that decides this using whatever logic you want.'),(0,r.kt)("h2",{id:"creating-the-custom-voter"},"Creating the custom Voter"),(0,r.kt)("p",null,'Suppose the logic to decide if a user can "view" or "edit" a Post object is pretty complex. For example, a User can always edit or view a Post they created. And if a Post is marked as "public", anyone can view it. A voter for this situation would look like this:'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"// src/Security/PostVoter.php\nnamespace App\\Security;\n\nuse App\\Entity\\Post;\nuse App\\Entity\\User;\nuse Symfony\\Component\\Security\\Core\\Authentication\\Token\\TokenInterface;\nuse Symfony\\Component\\Security\\Core\\Authorization\\Voter\\Voter;\n\nclass PostVoter extends Voter\n{\n    // these strings are just invented: you can use anything\n    const VIEW = 'view';\n    const EDIT = 'edit';\n\n    protected function supports($attribute, $subject)\n    {\n        // if the attribute isn't one we support, return false\n        if (!in_array($attribute, [self::VIEW, self::EDIT])) {\n            return false;\n        }\n\n        // only vote on `Post` objects\n        if (!$subject instanceof Post) {\n            return false;\n        }\n\n        return true;\n    }\n\n    protected function voteOnAttribute($attribute, $subject, TokenInterface $token)\n    {\n        $user = $token->getUser();\n\n        if (!$user instanceof User) {\n            // the user must be logged in; if not, deny access\n            return false;\n        }\n\n        // you know $subject is a Post object, thanks to `supports()`\n        /** @var Post $post */\n        $post = $subject;\n\n        switch ($attribute) {\n            case self::VIEW:\n                return $this->canView($post, $user);\n            case self::EDIT:\n                return $this->canEdit($post, $user);\n        }\n\n        throw new \\LogicException('This code should not be reached!');\n    }\n\n    private function canView(Post $post, User $user)\n    {\n        // if they can edit, they can view\n        if ($this->canEdit($post, $user)) {\n            return true;\n        }\n\n        // the Post object could have, for example, a method `isPrivate()`\n        return !$post->isPrivate();\n    }\n\n    private function canEdit(Post $post, User $user)\n    {\n        // this assumes that the Post object has a `getOwner()` method\n        return $user === $post->getOwner();\n    }\n}\n")),(0,r.kt)("h2",{id:"checking-for-roles-inside-a-voter"},"Checking for Roles inside a Voter\xb6"),(0,r.kt)("p",null,"What if you want to call ",(0,r.kt)("em",{parentName:"p"},"isGranted()")," from inside your voter - e.g. you want to see if the current user has ",(0,r.kt)("inlineCode",{parentName:"p"},"ROLE_SUPER_ADMIN"),". That's possible by injecting the ",(0,r.kt)("em",{parentName:"p"},"Security")," into your voter. You can use this to, for example, always allow access to a user with ",(0,r.kt)("inlineCode",{parentName:"p"},"ROLE_SUPER_ADMIN"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"// src/Security/PostVoter.php\n\n// ...\nuse Symfony\\Component\\Security\\Core\\Security;\n\nclass PostVoter extends Voter\n{\n    // ...\n\n    private $security;\n\n    public function __construct(Security $security)\n    {\n        $this->security = $security;\n    }\n\n    protected function voteOnAttribute($attribute, $subject, TokenInterface $token)\n    {\n        // ...\n\n        // ROLE_SUPER_ADMIN can do anything! The power!\n        if ($this->security->isGranted('ROLE_SUPER_ADMIN')) {\n            return true;\n        }\n\n        // ... all the normal voter logic\n    }\n}\n")),(0,r.kt)("p",null,"If you're using the default ",(0,r.kt)("em",{parentName:"p"},"services.yaml")," configuration, you're done! Symfony will automatically pass the ",(0,r.kt)("em",{parentName:"p"},"security.helper")," service when instantiating your voter (thanks to autowiring)."),(0,r.kt)("p",null,"All classes are automatically registered as services and configured to be autowired."),(0,r.kt)("h2",{id:"changing-the-access-decision-strategy"},"Changing the Access Decision Strategy"),(0,r.kt)("p",null,'Normally, only one voter will vote at any given time (the rest will "abstain", which means they return ',(0,r.kt)("em",{parentName:"p"},"false")," from ",(0,r.kt)("em",{parentName:"p"},"supports()"),"). But in theory, you could make multiple voters vote for one action and object. For instance, suppose you have one voter that checks if the user is a member of the site and a second one that checks if the user is older than 18."),(0,r.kt)("p",null,'To handle these cases, the access decision manager uses a "strategy" which you can configure. There are three strategies available:'),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"affirmative")," (default), This grants access as soon as there is one voter granting access;"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"consensus"),", This grants access if there are more voters granting access than denying;"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"unanimous"),", This only grants access if there is no voter denying access. If all voters abstained from voting, the decision is based on the ",(0,r.kt)("em",{parentName:"li"},"allow_if_all_abstain")," config option (which defaults to ",(0,r.kt)("em",{parentName:"li"},"false"),").")),(0,r.kt)("p",null,"In the above scenario, both voters should grant access in order to grant access to the user to read the post. In this case, the default strategy is no longer valid and ",(0,r.kt)("em",{parentName:"p"},"unanimous")," should be used instead. You can set this in the security configuration:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"# config/packages/security.yaml\nsecurity:\n    access_decision_manager:\n        strategy: unanimous\n        allow_if_all_abstain: false\n")))}p.isMDXComponent=!0}}]);