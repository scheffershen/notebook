"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[23630],{3905:(e,t,n)=>{n.d(t,{Zo:()=>l,kt:()=>b});var i=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n,i,r={},s=Object.keys(e);for(i=0;i<s.length;i++)n=s[i],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(i=0;i<s.length;i++)n=s[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=i.createContext({}),u=function(e){var t=i.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},l=function(e){var t=u(e.components);return i.createElement(p.Provider,{value:t},e.children)},c="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},d=i.forwardRef((function(e,t){var n=e.components,r=e.mdxType,s=e.originalType,p=e.parentName,l=o(e,["components","mdxType","originalType","parentName"]),c=u(n),d=r,b=c["".concat(p,".").concat(d)]||c[d]||h[d]||s;return n?i.createElement(b,a(a({ref:t},l),{},{components:n})):i.createElement(b,a({ref:t},l))}));function b(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=n.length,a=new Array(s);a[0]=d;var o={};for(var p in t)hasOwnProperty.call(t,p)&&(o[p]=t[p]);o.originalType=e,o[c]="string"==typeof e?e:r,a[1]=o;for(var u=2;u<s;u++)a[u]=n[u];return i.createElement.apply(null,a)}return i.createElement.apply(null,n)}d.displayName="MDXCreateElement"},13299:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>a,default:()=>c,frontMatter:()=>s,metadata:()=>o,toc:()=>u});var i=n(87462),r=(n(67294),n(3905));const s={},a="Adding Push Notifications to a Web App",o={unversionedId:"WebAPI/web-push/Adding Push Notifications to a Web App",id:"WebAPI/web-push/Adding Push Notifications to a Web App",title:"Adding Push Notifications to a Web App",description:"https://developers.google.com/web/fundamentals/codelabs/push-notifications/",source:"@site/docs/WebAPI/web-push/Adding Push Notifications to a Web App.md",sourceDirName:"WebAPI/web-push",slug:"/WebAPI/web-push/Adding Push Notifications to a Web App",permalink:"/notebook/docs/WebAPI/web-push/Adding Push Notifications to a Web App",draft:!1,editUrl:"https://github.com/scheffershen/notebook/tree/main/docs/WebAPI/web-push/Adding Push Notifications to a Web App.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Modern, responsive, cross-platform, self-hosted web IRC client",permalink:"/notebook/docs/WebAPI/web-irc/Modern, responsive, cross-platform, self-hosted web IRC client"},next:{title:"setting-up-a-notifications-system-in-symfony-projects",permalink:"/notebook/docs/WebAPI/web-push/setting-up-a-notifications-system-in-symfony-project"}},p={},u=[],l={toc:u};function c(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,i.Z)({},l,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"adding-push-notifications-to-a-web-app"},"Adding Push Notifications to a Web App"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://developers.google.com/web/fundamentals/codelabs/push-notifications/"},"https://developers.google.com/web/fundamentals/codelabs/push-notifications/"),"\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Minishlink/web-push-php-example"},"https://github.com/Minishlink/web-push-php-example"),"\n",(0,r.kt)("a",{parentName:"p",href:"https://serviceworke.rs/push-rich_index_doc.html"},"https://serviceworke.rs/push-rich_index_doc.html")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"GCM")," (google cloud messaging) - a mobile notification service developed by Google that enables third-party application developers to send notification data or information from developer-run servers to applications."),(0,r.kt)("p",null,"##Download the sample code"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"git clone https://github.com/GoogleChrome/push-notifications.git\n")),(0,r.kt)("p",null,"##Download the sample code php"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/Minishlink/web-push-php-example"},"https://github.com/Minishlink/web-push-php-example")),(0,r.kt)("p",null,"##Creating VAPID keys"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://www.cargomedia.ch/2016/12/14/quickstart-web-push-notifications.html"},"https://www.cargomedia.ch/2016/12/14/quickstart-web-push-notifications.html")," (14 Dec 2016)"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"npm install web-push -g\nweb-push generate-vapid-keys\n")),(0,r.kt)("p",null,"##Checking browser support"),(0,r.kt)("p",null,"We will need a couple of things to handle push notifications on the client side."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"/**\n * @return Boolean\n */\nvar push_supported = function() {\n    if (!('navigator' in window && 'serviceWorker' in navigator)) {\n        return false;\n    }\n    if (!('ServiceWorkerRegistration' in window && 'pushManager' in ServiceWorkerRegistration.prototype && 'showNotification' in ServiceWorkerRegistration.prototype)) {\n        return false;\n    }\n    if (!('Uint8Array' in window)) {\n        return false;\n    }\n    return true;\n};\n")),(0,r.kt)("p",null,"##Preparing your public key"),(0,r.kt)("p",null,"You will need to convert your public VAPID key from a Base64-URL encoded string to an array of bytes first. "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"/**\n * @param {String} push_publicKey\n * @return Uint8Array\n */\nvar push_applicationServerKey = function(push_publicKey) {\n    const padding = '='.repeat((4 - push_publicKey.length % 4) % 4);\n    const base64 = (push_publicKey + padding)\n        .replace(/\\-/g, '+')\n        .replace(/_/g, '/');\n    const rawData = window.atob(base64);\n    const byteArray = new Uint8Array(rawData.length);\n    for (let i = 0; i < rawData.length; i++) {\n        byteArray[i] = rawData.charCodeAt(i);\n    }\n    return byteArray;\n};\n")),(0,r.kt)("p",null,"##Enabling the UI"),(0,r.kt)("p",null,"Check then if the user has already subscribed to push notifications by using the following function:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"/**\n * @param {Function} push_enableUI\n * @param {Function} push_updateSubscription\n * @param {String} push_updateSubscriptionUrl\n * @return Promise\n */\nvar push_initialize = function(push_enableUI, push_updateSubscription, push_updateSubscriptionUrl) {\n    return navigator.serviceWorker.ready\n        .then(function(serviceWorkerRegistration) {\n            return serviceWorkerRegistration.pushManager.getSubscription();\n        })\n        .then(function(subscription) {\n            if (!subscription) {\n                return push_enableUI();\n            }\n            return push_updateSubscription(subscription, push_updateSubscriptionUrl);\n        });\n};\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"push_enableUI(): is a function returning a promise that will activate any UI required to prompt the user to opt-in to push notifications, e.g. a pop-up"),(0,r.kt)("li",{parentName:"ul"},"push_updateSubscription(): is a function returning a promise that will forward the authentication details to the web server where they will be stored"),(0,r.kt)("li",{parentName:"ul"},"push_updateSubscriptionUrl(): is the URL of the API endpoint receiving authentication details on the web server")),(0,r.kt)("p",null,"##Prompting the user to opt-in to push notifications"),(0,r.kt)("p",null,"When the user interacts with the UI enabled by push_enableUI(), prompt him to opt-in to push notifications with the function:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"/**\n * @param {String} push_publicKey\n * @param {Function} push_updateSubscription\n * @param {String} push_updateSubscriptionUrl\n * @return Promise\n */\nvar push_requestSubscription = function(push_publicKey, push_updateSubscription, push_updateSubscriptionUrl) {\n    return navigator.serviceWorker.ready\n        .then(function(serviceWorkerRegistration) {\n            return serviceWorkerRegistration.pushManager.subscribe({\n                userVisibleOnly: true,\n                applicationServerKey: push_applicationServerKey(push_publicKey)\n            });\n        })\n        .then(function(push_subscription) {\n            return push_updateSubscription(push_subscription, push_updateSubscriptionUrl);\n        });\n};\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"push_publicKey(): is the public VAPID key, which will be converted using the function push_applicationServerKey described above"),(0,r.kt)("li",{parentName:"ul"},"push_updateSubscription() is the same function as above, that will forward the authentication details to the web server"),(0,r.kt)("li",{parentName:"ul"},"push_updateSubscriptionUrl() is the same URL as above for the API endpoint receiving authentication details on the web server")),(0,r.kt)("p",null,"##Sending authentication details to the server"),(0,r.kt)("p",null,"You will need to implement an API endpoint to receive authentication details on your web server. "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"/**\n * @param {Object} push_subscription\n * @return Promise\n */\nvar push_updateSubscription = function(push_subscription, push_updateSubscriptionUrl) {\n    return new Promise(function(resolve, reject) {\n        var request = new XMLHttpRequest();\n        request.open('POST', 'https://example.com/push-subscription');\n        request.setRequestHeader('Content-Type', 'application/json');\n        request.onload = function() {\n            if (this.status >= 200 && this.status < 300) {\n                resolve(request.response);\n            } else {\n                reject({\n                    status: this.status,\n                    statusText: request.statusText\n                });\n            }\n        };\n        request.onerror = function() {\n            reject({\n                status: this.status,\n                statusText: request.statusText\n            });\n        };\n        request.send(JSON.stringify(push_subscription));\n    });\n};\n")),(0,r.kt)("p",null,"This function expects as an argument the push_subscription object returned by the push manager, which looks like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'{\n    "endpoint": "https://example.com/push-service/send/dbDqU8xX10w:APA91b...",\n    "keys": {\n        "auth": "qLAYRzG9TnUwbprns6H2Ew==",\n        "p256dh": "BILXd-c1-zuEQYXH\\\\_tc3qmLq52cggfqqTr\\\\_ZclwqYl6A7-RX2J0NG3icsw..."\n    }\n}\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"endpoint: contains the URL of the notification channel where push notifications must be sent to in order to reach the user. The first part is the URL of the messaging service of the browser vendor, while the second part identifies the user resp. his web browser."),(0,r.kt)("li",{parentName:"ul"},"keys.auth: is a 16 byte authentication secret generated by the browser."),(0,r.kt)("li",{parentName:"ul"},"keys.p256dh: is the public key in ANSI X9.62 format.")),(0,r.kt)("p",null,"##Sending push notifications"),(0,r.kt)("p",null,"To send a batch of notifications to your subscribers using this library in php, you can use the function:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"/**\n * @param array $push_notificationList\n * @param string $push_administrativeContact\n * @param string $push_publicKey\n * @param string $push_privateKey\n */\nfunction push_sendNotifications(array $push_notificationList, $push_administrativeContact, $push_publicKey, $push_privateKey) {\n    $webPush = new \\Minishlink\\WebPush\\WebPush([\n        'VAPID' => [\n            'subject' => 'mailto:' . $push_administrativeContact,\n            'publicKey' => $push_publicKey,\n            'privateKey' => $push_privateKey,\n        ]\n    ]);\n    foreach ($push_notificationList as $push_notification) {\n        $webPush->sendNotification($push_notification['subscription']['endpoint'], $push_notification['message'], $push_notification['subscription']['keys']['p256dh'], $push_notification['subscription']['keys']['auth']);\n    }\n    $webPush->flush();\n}\n")),(0,r.kt)("p",null,"The argument ",(0,r.kt)("em",{parentName:"p"},"$push_notificationList")," is an array of arrays, each one containing:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"* an entry subscription with the authentication details of a user, as above\n* an entry message with the push notification to send to this user, usually as a JSON string (see below)\n")),(0,r.kt)("p",null,"The email address ",(0,r.kt)("em",{parentName:"p"},"$push_administrativeContact")," will get notified by the messaging service of the different browser vendors in case of an error."),(0,r.kt)("p",null,"##Receiving push notifications"),(0,r.kt)("p",null,"You will need to register first the service worker that will handle push notifications. "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"/**\n * @param {String} push_serviceWorkerUrl\n * @param {Function} push_initialize\n * @param {Function} push_enableUI\n * @param {Function} push_updateSubscription\n * @param {String} push_updateSubscriptionUrl\n * @return Promise\n */\nvar push_registerServiceWorker = function(push_serviceWorkerUrl, push_initialize, push_enableUI, push_updateSubscription, push_updateSubscriptionUrl) {\n    return navigator.serviceWorker.register(push_serviceWorkerUrl)\n        .then(function(push_serviceWorker) {\n            return push_initialize(push_enableUI, push_updateSubscription, push_updateSubscriptionUrl);\n        });\n};\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"push_serviceWorkerUrl() is the URL of the JavaScript code of your service worker (see below)"),(0,r.kt)("li",{parentName:"ul"},"push_initialize() is the same function as above to check if the user has already subscribed to push notifications"),(0,r.kt)("li",{parentName:"ul"},"push_enableUI() is the same function as above to activate the UI required to prompt the user to opt-in to push notifications"),(0,r.kt)("li",{parentName:"ul"},"push_updateSubscription() is the same function as above, that will forward the authentication details to the web server"),(0,r.kt)("li",{parentName:"ul"},"push_updateSubscriptionUrl() is the same URL as above for the API endpoint receiving authentication details on the web server")),(0,r.kt)("p",null,"##Implementing your service worker"),(0,r.kt)("p",null,"The service worker listens to push notifications, displays them and implements any interaction. "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"self.addEventListener('push', function(event) {\n    if (event.data) {\n        var promise = Promise.resolve(event.data.json())\n            .then(function(data) {\n                var options = data.options || {};\n                options.data = data;\n                return self.registration.showNotification(data.title, data.options);\n            });\n        event.waitUntil(promise);\n    }\n});\n\nself.addEventListener('notificationclick', function(event) {\n    event.notification.close();\n    var href = event.notification.data.href || '/';\n    clients.openWindow(href);\n}, false);\n")),(0,r.kt)("p",null,"This service worker expects your notification messages - the entries $push_notification","['message']"," in your web application above - to use the following format:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'{\n    "title": "Notification title",\n    "href": "URL of the landing page",\n    "body": "Notification content",\n    "icon": "Notification icon URL (256x256)"\n}\n')),(0,r.kt)("p",null,"##Putting all the pieces together"),(0,r.kt)("p",null,"Now in order to use notifications on your website, you just have to implement a API endpoint to subscribe users, to implement push_enableUI depending on your UI requirements, and to publish and register your service worker:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"var push_publicKey = 'BPq3aXK9cqxqNDkOUgltP1y75tlPXNp-ZA9dAazSrwm...';\nvar push_updateSubscriptionUrl = 'https://example.com/push-update-subscription';\nvar push_serviceWorkerUrl = '/push-service-worker.js';\n\nvar push_enableUI = function() {\n    return new Promise(function(resolve, reject) {\n        if (confirm('Would you like to receive notifications?')) {\n            push_requestSubscription(push_publicKey, push_updateSubscription, push_updateSubscriptionUrl);\n        }\n        resolve();\n    });\n};\n\nif (push_supported()) {\n    window.addEventListener('load', function() {\n        push_registerServiceWorker(push_serviceWorkerUrl, push_initialize, push_enableUI, push_updateSubscription, push_updateSubscriptionUrl)\n    });\n}\n")))}c.isMDXComponent=!0}}]);